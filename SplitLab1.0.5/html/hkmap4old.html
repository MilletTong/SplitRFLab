
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>hkmap4old</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-02-24"><meta name="DC.source" content="hkmap4old.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">read sac</a></li><li><a href="#6">Read RF data</a></li><li><a href="#8">H-k stacking</a></li><li><a href="#9">Calculate the predicted travel times at the best estimated Mohodepth and Kappa</a></li><li><a href="#10">plot H-kappa stacking map</a></li><li><a href="#11">Output results</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> hkmap4old(Datapath,OUT_path,mapath,h1,h2,k1,k2,sh1,sh2,sk1,sk2,Constantvp)
</pre><pre class="codeinput"><span class="keyword">global</span> config

shift = 10;
Moho = h1:0.1:h2;
kappa = k1:0.01:k2;
weight = [ 0.7, 0.2, 0.1 ] ;<span class="comment">% weighting matrix</span>

<span class="keyword">if</span> config.issac
</pre><h2>read sac<a name="3"></a></h2><pre class="codeinput">path = fullfile(Datapath,config.stnname);
sac_all = dir(fullfile(path,<span class="string">'*R.sac'</span>));
dat = struct();
<span class="keyword">for</span> i = 1:length(sac_all)
    sac_split = regexp(sac_all(i).name,<span class="string">'_'</span>,<span class="string">'split'</span>);
    sacname = sac_split(1);
    nowsac = rsac(fullfile(path,sac_all(i).name));
    dat(i).name = sacname;
    dat(i).R = nowsac(:,2);
    dat(i).rayp = lh(nowsac,<span class="string">'USER0'</span>);
    dat(i).bazi = lh(nowsac,<span class="string">'BAZ'</span>);
<span class="keyword">end</span>
EV_num = length(dat);
rayp = zeros(EV_num,1);
<span class="keyword">for</span> i = 1:EV_num
    rayp(i) = dat(i).rayp;
<span class="keyword">end</span>
[rayp,idx] = sort(rayp);
dat = dat(idx);
RFlength = length(dat(1).R);
datar = zeros(RFlength,EV_num);
<span class="keyword">for</span> i = 1:EV_num
    disp([char(dat(i).name) <span class="string">' --s.event number: '</span> num2str(i)]);
    datar(:,i) = dat(i).R;
<span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">else</span>
</pre><pre class="codeinput">[s.event s.phase s.evlat s.evlon s.evdep s.dis s.bazi s.rayp s.magnitude s.f0]=textread([Datapath <span class="string">'/'</span> config.stnname <span class="string">'/'</span> config.stnname <span class="string">'finallist.dat'</span>],<span class="string">'%s %s %f %f %f %f %f %f %f %f'</span>,-1);
<span class="comment">%sort by rayp</span>
[rayp, idx]=sort(s.rayp);
s.event=s.event(idx);
s.phase=s.phase(idx);
s.evlat=s.evlat(idx);
s.evlon=s.evlon(idx);
s.evdep=s.evdep(idx);
s.dis=s.dis(idx);
s.bazi=s.bazi(idx);
s.magnitude=s.magnitude(idx);

EV_num=length(s.evdep);
backazimuth=num2str(s.bazi,<span class="string">'%5.1f\n'</span>);
distance=num2str(s.dis,<span class="string">'%5.1f\n'</span>);
raypara=num2str(s.rayp,<span class="string">'%5.3f\n'</span>);
</pre><h2>Read RF data<a name="6"></a></h2><pre class="codeinput">m=1;
<span class="keyword">while</span> 1
    <span class="keyword">if</span> m==EV_num+1
    <span class="keyword">break</span>,<span class="keyword">end</span>;
filename=s.event(m,:);
disp([char(filename) <span class="string">' --s.event number: '</span> num2str(m)]);
datafile=strcat([Datapath <span class="string">'/'</span> config.stnname <span class="string">'/'</span>],filename,<span class="string">'_'</span>,s.phase(m,:),<span class="string">'_R.dat'</span>);
datar(:,m)=load(char(datafile));
m=m+1;
<span class="keyword">end</span>
RFlength=length(datar(:,1));
</pre><pre class="codeinput"><span class="keyword">end</span>

sampling = (config.extime_after + config.extime_before) / (RFlength - 1);
</pre><pre class="codeoutput error">Error using hkmap4old (line 6)
Not enough input arguments.
</pre><h2>H-k stacking<a name="8"></a></h2><pre class="codeinput"><span class="comment">%----------------------------------------------------------------------</span>
[stack, ~, ~, stackall_var ] = hkstack_iwb( datar, -shift, sampling, rayp, Moho, kappa, Constantvp,weight );
<span class="comment">%[stack_all, stackall_var,besth, bestk] = hkstack(datar,-shift,sampling,s.rayp,Moho,kappa,Constantvp,weight,1,0);</span>
<span class="comment">% combine the stacks</span>
allstack = weight(1)*stack(:,:,1) + weight(2)*stack(:,:,2) + weight(3)*stack(:,:,3);
Normed_stack = allstack - min(min(allstack));
Normed_stack = Normed_stack./max(max(Normed_stack));
sh= Moho&gt;sh1 &amp; Moho&lt;sh2;
sk= kappa&gt;sk1 &amp; kappa&lt;sk2;
[maxA, i] = max(max(Normed_stack(sk,sh)));
[i,j] = find( Normed_stack == maxA ,1);
besth = Moho(j);
bestk = kappa(i);
<span class="comment">%onesigma = maxA - sqrt(stackall_var(i,j));</span>
fprintf(<span class="string">'Best Mohodepth = %.2f km\nBest kappa = %.2f\n'</span>, [besth,bestk] );
<span class="comment">%Estimate the confidence bounds by the contours at the 1-sigma value</span>
Temnormed_stack = (Normed_stack)';
cvalue = 1 - std(reshape(Temnormed_stack,1,numel(Temnormed_stack)))/sqrt(EV_num);
c = contourc(kappa,Moho,Temnormed_stack,[cvalue cvalue]);
NumContours = find(c(1,:) == cvalue);
    <span class="keyword">if</span> length(NumContours) == 1
        Maxksig = (max(c(1,2:end)) - min(c(1,2:end)))/2;
        MaxHsig = (max(c(2,2:end)) - min(c(2,2:end)))/2;
    <span class="keyword">else</span>
        [junk,IndexOfMaxk]=min(abs(c(1,:) - bestk));
        RightContour = find(NumContours &lt; IndexOfMaxk,1,<span class="string">'last'</span>);
        <span class="keyword">if</span> RightContour ~= length(NumContours)
            Maxksig = (max(c(1,NumContours(RightContour)+1:NumContours(RightContour+1)-1)) - min(c(1,NumContours(RightContour)+1:NumContours(RightContour+1)-1)))/2;
            MaxHsig = (max(c(2,NumContours(RightContour)+1:NumContours(RightContour+1)-1)) - min(c(2,NumContours(RightContour)+1:NumContours(RightContour+1)-1)))/2;
        <span class="keyword">else</span>
            Maxksig = (max(c(1,NumContours(RightContour)+1:end)) - min(c(1,NumContours(RightContour)+1:end)))/2;
            MaxHsig = (max(c(2,NumContours(RightContour)+1:end)) - min(c(2,NumContours(RightContour)+1:end)))/2;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2>Calculate the predicted travel times at the best estimated Mohodepth and Kappa<a name="9"></a></h2><pre class="codeinput">eta_p = vslow( Constantvp,rayp);  <span class="comment">% get vp vertical slowness</span>
eta_s = vslow( Constantvp./bestk, rayp); <span class="comment">% get vertical slowness for all vs</span>
TPs = tPs(besth, eta_p, eta_s );
TPpPs = tPpPs(besth, eta_p, eta_s );
TPsPs = tPsPs(besth, eta_s );
</pre><h2>plot H-kappa stacking map<a name="10"></a></h2><pre class="codeinput">h=figure(81);
subplot(2,2,1)
imagesc(Moho, kappa, stack(:,:,1)); hold <span class="string">on</span>;
load(<span class="string">'cyan.mat'</span>,<span class="string">'cyan'</span>);
colormap(cyan);hold <span class="string">on</span>;
plot( besth, bestk, <span class="string">'wx'</span>, <span class="string">'MarkerSize'</span>,10,<span class="string">'LineWidth'</span>,1.5)
axis <span class="string">square</span>
cb1 = colorbar(<span class="string">'peer'</span>,gca);
set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>,<span class="string">'xlim'</span>,[h1 h2],<span class="string">'xminortick'</span>,<span class="string">'on'</span>,<span class="string">'yminortick'</span>,<span class="string">'on'</span>)
set(gca,<span class="string">'ticklength'</span>,[0.03,0.5],<span class="string">'linewidth'</span>,1.0,<span class="string">'fontsize'</span>,15);
ylabel( <span class="string">'Vp/Vs'</span>, <span class="string">'FontSize'</span>,16 )
xlabel( <span class="string">'H (km)'</span>, <span class="string">'FontSize'</span>,16 )
title(<span class="string">'Ps'</span>,  <span class="string">'fontname'</span>,<span class="string">'Times new roman'</span>,<span class="string">'FontSize'</span>,16)

subplot(2,2,2)
imagesc(Moho, kappa, stack(:,:,2)); hold <span class="string">on</span>;
colormap(cyan);hold <span class="string">on</span>;
plot( besth, bestk, <span class="string">'wx'</span>, <span class="string">'MarkerSize'</span>,10,<span class="string">'LineWidth'</span>,1.5)
axis <span class="string">square</span>
cb2 = colorbar(<span class="string">'peer'</span>,gca);
set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>,<span class="string">'xlim'</span>,[h1 h2],<span class="string">'xminortick'</span>,<span class="string">'on'</span>,<span class="string">'yminortick'</span>,<span class="string">'on'</span>)
set(gca,<span class="string">'ticklength'</span>,[0.03,0.5],<span class="string">'linewidth'</span>,1.0,<span class="string">'fontsize'</span>,15);
ylabel( <span class="string">'Vp/Vs'</span>, <span class="string">'FontSize'</span>,16 )
xlabel( <span class="string">'H (km)'</span>, <span class="string">'FontSize'</span>,16 )
title(<span class="string">'PpPs'</span>, <span class="string">'fontname'</span>,<span class="string">'Times new roman'</span>, <span class="string">'FontSize'</span>,16)

subplot(2,2,3)
imagesc(Moho, kappa, stack(:,:,3)); hold <span class="string">on</span>;
colormap(cyan);hold <span class="string">on</span>;
plot( besth, bestk, <span class="string">'wx'</span>, <span class="string">'MarkerSize'</span>,10,<span class="string">'LineWidth'</span>,1.5)
axis <span class="string">square</span>
cb3 = colorbar(<span class="string">'peer'</span>,gca);
set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>,<span class="string">'xlim'</span>,[h1 h2],<span class="string">'xminortick'</span>,<span class="string">'on'</span>,<span class="string">'yminortick'</span>,<span class="string">'on'</span>)
set(gca,<span class="string">'ticklength'</span>,[0.03,0.5],<span class="string">'linewidth'</span>,1.0,<span class="string">'fontsize'</span>,15);
ylabel( <span class="string">'Vp/Vs'</span>, <span class="string">'FontSize'</span>,16 )
xlabel( <span class="string">'H (km)'</span>, <span class="string">'FontSize'</span>,16 )
title(<span class="string">'PsPs &amp; PpSs'</span>, <span class="string">'fontname'</span>,<span class="string">'Times new roman'</span>, <span class="string">'FontSize'</span>,16)

subplot(2,2,4)
imagesc(Moho, kappa, Normed_stack); hold <span class="string">on</span>;
colormap(cyan);hold <span class="string">on</span>;
plot( besth, bestk, <span class="string">'wx'</span>, <span class="string">'MarkerSize'</span>,10,<span class="string">'LineWidth'</span>,1.5)
axis <span class="string">square</span>
<span class="comment">%contourf(Moho,kappa,stack_all,'LineStyle','none');hold on;%plot the 1-sigma contour</span>
<span class="comment">%tempstr = num2str(onesigma);</span>
<span class="comment">%onesigma = str2double(tempstr(1:5));</span>
[~, bb] = contour(Moho,kappa,Normed_stack,[cvalue],<span class="string">'ShowText'</span>,<span class="string">'off'</span>,<span class="string">'linestyle'</span>,<span class="string">'-'</span>,<span class="string">'linewidth'</span>,1.5,<span class="string">'linecolor'</span>,<span class="string">'k'</span>);
cb4 = colorbar(<span class="string">'peer'</span>,gca);
<span class="comment">%clabel(cc,bb,'fontsize',10,'FontName','Arial','color','k','rotation',0)</span>
set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>,<span class="string">'xlim'</span>,[h1 h2],<span class="string">'xminortick'</span>,<span class="string">'on'</span>,<span class="string">'yminortick'</span>,<span class="string">'on'</span>)
set(gca,<span class="string">'ticklength'</span>,[0.03,0.5],<span class="string">'linewidth'</span>,1.0,<span class="string">'fontsize'</span>,15);
line([besth besth], ylim,<span class="string">'Color'</span>,<span class="string">'w'</span>,<span class="string">'LineWidth'</span>,1.5);line(xlim, [bestk bestk],<span class="string">'Color'</span>,<span class="string">'w'</span>,<span class="string">'LineWidth'</span>,1.5);
ylabel( <span class="string">'Vp/Vs'</span>,<span class="string">'FontSize'</span>,16 )
xlabel( <span class="string">'H (km)'</span>, <span class="string">'FontSize'</span>,16 )
title([<span class="string">'w1: '</span> num2str(weight(1)) <span class="string">', w2: '</span> num2str(weight(2)) <span class="string">', w3: '</span> num2str(weight(3))],  <span class="string">'fontname'</span>,<span class="string">'Times new roman'</span>,<span class="string">'FontSize'</span>,16)
 button1 = MFquestdlg( [ 0.4 , 0.12 ] ,<span class="string">'Do you want to save the plot ?'</span>,<span class="string">'plot'</span>,  <span class="keyword">...</span>
     <span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
 <span class="keyword">if</span> strcmp(button1, <span class="string">'Yes'</span>)

print(h,<span class="string">'-dpdf'</span>, [mapath <span class="string">'/'</span> config.stnname <span class="string">'hkmap.pdf'</span>])
<span class="keyword">end</span>
</pre><h2>Output results<a name="11"></a></h2><pre class="codeinput"> button1 = MFquestdlg( [ 0.4 , 0.12 ] ,<span class="string">'Do you want to save the H-k list ?'</span>,<span class="string">'list'</span>,  <span class="keyword">...</span>
     <span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
 <span class="keyword">if</span> strcmp(button1, <span class="string">'Yes'</span>)
fid=fopen(OUT_path,<span class="string">'a+'</span>);
<span class="keyword">if</span> isempty(fid)
    fprintf(fid,<span class="string">'H-k stacking results'</span>);
    fprintf(fid,<span class="string">'\n-------------------------------------------------------------------------------------------------------------------------------------'</span>);
    fprintf(fid,<span class="string">'\n Station Stalat Stalon RFnumber w1 w2 w3 Mohodepth deltaMoho kappa deltakappa'</span>);
<span class="keyword">end</span>
    fseek(fid,0,<span class="string">'eof'</span>);
    fprintf(fid,<span class="string">'\n %s %6.2f %6.2f %u %f %f %f %f %f %f %f'</span>,config.stnname,config.slat,config.slong,EV_num,weight(1), weight(2),weight(3),besth,MaxHsig,bestk,Maxksig);
    fclose(fid);
 <span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
function hkmap4old(Datapath,OUT_path,mapath,h1,h2,k1,k2,sh1,sh2,sk1,sk2,Constantvp)

global config

shift = 10;
Moho = h1:0.1:h2;
kappa = k1:0.01:k2;
weight = [ 0.7, 0.2, 0.1 ] ;% weighting matrix

if config.issac 
%% read sac
path = fullfile(Datapath,config.stnname);
sac_all = dir(fullfile(path,'*R.sac'));
dat = struct();
for i = 1:length(sac_all)
    sac_split = regexp(sac_all(i).name,'_','split');
    sacname = sac_split(1);
    nowsac = rsac(fullfile(path,sac_all(i).name));
    dat(i).name = sacname;
    dat(i).R = nowsac(:,2);
    dat(i).rayp = lh(nowsac,'USER0');
    dat(i).bazi = lh(nowsac,'BAZ');    
end
EV_num = length(dat);
rayp = zeros(EV_num,1);
for i = 1:EV_num
    rayp(i) = dat(i).rayp;
end
[rayp,idx] = sort(rayp);
dat = dat(idx);
RFlength = length(dat(1).R);
datar = zeros(RFlength,EV_num);
for i = 1:EV_num
    disp([char(dat(i).name) ' REPLACE_WITH_DASH_DASHs.event number: ' num2str(i)]);
    datar(:,i) = dat(i).R;
end
else
[s.event s.phase s.evlat s.evlon s.evdep s.dis s.bazi s.rayp s.magnitude s.f0]=textread([Datapath '/' config.stnname '/' config.stnname 'finallist.dat'],'%s %s %f %f %f %f %f %f %f %f',-1);
%sort by rayp
[rayp, idx]=sort(s.rayp);
s.event=s.event(idx);
s.phase=s.phase(idx);
s.evlat=s.evlat(idx);
s.evlon=s.evlon(idx);
s.evdep=s.evdep(idx);
s.dis=s.dis(idx);
s.bazi=s.bazi(idx);
s.magnitude=s.magnitude(idx);

EV_num=length(s.evdep);
backazimuth=num2str(s.bazi,'%5.1f\n');
distance=num2str(s.dis,'%5.1f\n');
raypara=num2str(s.rayp,'%5.3f\n');
%% Read RF data
m=1;
while 1
    if m==EV_num+1
    break,end;
filename=s.event(m,:);
disp([char(filename) ' REPLACE_WITH_DASH_DASHs.event number: ' num2str(m)]);
datafile=strcat([Datapath '/' config.stnname '/'],filename,'_',s.phase(m,:),'_R.dat');
datar(:,m)=load(char(datafile));
m=m+1;
end
RFlength=length(datar(:,1));
end

sampling = (config.extime_after + config.extime_before) / (RFlength - 1);
%% H-k stacking 
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
[stack, ~, ~, stackall_var ] = hkstack_iwb( datar, -shift, sampling, rayp, Moho, kappa, Constantvp,weight );
%[stack_all, stackall_var,besth, bestk] = hkstack(datar,-shift,sampling,s.rayp,Moho,kappa,Constantvp,weight,1,0);
% combine the stacks 
allstack = weight(1)*stack(:,:,1) + weight(2)*stack(:,:,2) + weight(3)*stack(:,:,3);
Normed_stack = allstack - min(min(allstack));
Normed_stack = Normed_stack./max(max(Normed_stack));
sh= Moho>sh1 & Moho<sh2;
sk= kappa>sk1 & kappa<sk2;
[maxA, i] = max(max(Normed_stack(sk,sh)));
[i,j] = find( Normed_stack == maxA ,1);
besth = Moho(j);
bestk = kappa(i);
%onesigma = maxA - sqrt(stackall_var(i,j));
fprintf('Best Mohodepth = %.2f km\nBest kappa = %.2f\n', [besth,bestk] );
%Estimate the confidence bounds by the contours at the 1-sigma value
Temnormed_stack = (Normed_stack)';
cvalue = 1 - std(reshape(Temnormed_stack,1,numel(Temnormed_stack)))/sqrt(EV_num);
c = contourc(kappa,Moho,Temnormed_stack,[cvalue cvalue]);
NumContours = find(c(1,:) == cvalue);
    if length(NumContours) == 1
        Maxksig = (max(c(1,2:end)) - min(c(1,2:end)))/2;
        MaxHsig = (max(c(2,2:end)) - min(c(2,2:end)))/2;
    else
        [junk,IndexOfMaxk]=min(abs(c(1,:) - bestk));
        RightContour = find(NumContours < IndexOfMaxk,1,'last');
        if RightContour ~= length(NumContours)
            Maxksig = (max(c(1,NumContours(RightContour)+1:NumContours(RightContour+1)-1)) - min(c(1,NumContours(RightContour)+1:NumContours(RightContour+1)-1)))/2;
            MaxHsig = (max(c(2,NumContours(RightContour)+1:NumContours(RightContour+1)-1)) - min(c(2,NumContours(RightContour)+1:NumContours(RightContour+1)-1)))/2;
        else
            Maxksig = (max(c(1,NumContours(RightContour)+1:end)) - min(c(1,NumContours(RightContour)+1:end)))/2;
            MaxHsig = (max(c(2,NumContours(RightContour)+1:end)) - min(c(2,NumContours(RightContour)+1:end)))/2;
        end
    end


%% Calculate the predicted travel times at the best estimated Mohodepth and Kappa 
eta_p = vslow( Constantvp,rayp);  % get vp vertical slowness
eta_s = vslow( Constantvp./bestk, rayp); % get vertical slowness for all vs
TPs = tPs(besth, eta_p, eta_s );
TPpPs = tPpPs(besth, eta_p, eta_s );
TPsPs = tPsPs(besth, eta_s );
%% plot H-kappa stacking map
h=figure(81);
subplot(2,2,1)
imagesc(Moho, kappa, stack(:,:,1)); hold on;
load('cyan.mat','cyan');
colormap(cyan);hold on;
plot( besth, bestk, 'wx', 'MarkerSize',10,'LineWidth',1.5)
axis square
cb1 = colorbar('peer',gca);
set(gca,'YDir','normal','xlim',[h1 h2],'xminortick','on','yminortick','on')
set(gca,'ticklength',[0.03,0.5],'linewidth',1.0,'fontsize',15);
ylabel( 'Vp/Vs', 'FontSize',16 )
xlabel( 'H (km)', 'FontSize',16 )
title('Ps',  'fontname','Times new roman','FontSize',16)

subplot(2,2,2)
imagesc(Moho, kappa, stack(:,:,2)); hold on;
colormap(cyan);hold on;
plot( besth, bestk, 'wx', 'MarkerSize',10,'LineWidth',1.5)
axis square
cb2 = colorbar('peer',gca);
set(gca,'YDir','normal','xlim',[h1 h2],'xminortick','on','yminortick','on')
set(gca,'ticklength',[0.03,0.5],'linewidth',1.0,'fontsize',15);
ylabel( 'Vp/Vs', 'FontSize',16 )
xlabel( 'H (km)', 'FontSize',16 )
title('PpPs', 'fontname','Times new roman', 'FontSize',16)

subplot(2,2,3)
imagesc(Moho, kappa, stack(:,:,3)); hold on;
colormap(cyan);hold on;
plot( besth, bestk, 'wx', 'MarkerSize',10,'LineWidth',1.5)
axis square
cb3 = colorbar('peer',gca);
set(gca,'YDir','normal','xlim',[h1 h2],'xminortick','on','yminortick','on')
set(gca,'ticklength',[0.03,0.5],'linewidth',1.0,'fontsize',15);
ylabel( 'Vp/Vs', 'FontSize',16 )
xlabel( 'H (km)', 'FontSize',16 )
title('PsPs & PpSs', 'fontname','Times new roman', 'FontSize',16)

subplot(2,2,4)
imagesc(Moho, kappa, Normed_stack); hold on;
colormap(cyan);hold on;
plot( besth, bestk, 'wx', 'MarkerSize',10,'LineWidth',1.5)
axis square
%contourf(Moho,kappa,stack_all,'LineStyle','none');hold on;%plot the 1-sigma contour
%tempstr = num2str(onesigma);
%onesigma = str2double(tempstr(1:5));
[~, bb] = contour(Moho,kappa,Normed_stack,[cvalue],'ShowText','off','linestyle','-','linewidth',1.5,'linecolor','k');
cb4 = colorbar('peer',gca);
%clabel(cc,bb,'fontsize',10,'FontName','Arial','color','k','rotation',0)
set(gca,'YDir','normal','xlim',[h1 h2],'xminortick','on','yminortick','on')
set(gca,'ticklength',[0.03,0.5],'linewidth',1.0,'fontsize',15);
line([besth besth], ylim,'Color','w','LineWidth',1.5);line(xlim, [bestk bestk],'Color','w','LineWidth',1.5); 
ylabel( 'Vp/Vs','FontSize',16 )
xlabel( 'H (km)', 'FontSize',16 )
title(['w1: ' num2str(weight(1)) ', w2: ' num2str(weight(2)) ', w3: ' num2str(weight(3))],  'fontname','Times new roman','FontSize',16)
 button1 = MFquestdlg( [ 0.4 , 0.12 ] ,'Do you want to save the plot ?','plot',  ...
     'Yes','No','Yes');
 if strcmp(button1, 'Yes') 

print(h,'-dpdf', [mapath '/' config.stnname 'hkmap.pdf'])
end
%% Output results


 button1 = MFquestdlg( [ 0.4 , 0.12 ] ,'Do you want to save the H-k list ?','list',  ...
     'Yes','No','Yes');
 if strcmp(button1, 'Yes') 
fid=fopen(OUT_path,'a+');
if isempty(fid)
    fprintf(fid,'H-k stacking results');
    fprintf(fid,'\nREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
    fprintf(fid,'\n Station Stalat Stalon RFnumber w1 w2 w3 Mohodepth deltaMoho kappa deltakappa');
end
    fseek(fid,0,'eof');
    fprintf(fid,'\n %s %6.2f %6.2f %u %f %f %f %f %f %f %f',config.stnname,config.slat,config.slong,EV_num,weight(1), weight(2),weight(3),besth,MaxHsig,bestk,Maxksig);
    fclose(fid);
 end
##### SOURCE END #####
--></body></html>